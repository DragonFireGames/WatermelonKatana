<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Edit Profile | WatermelonKatana</title>
    <link rel="stylesheet" type="text/css" href="/styles/style.css">
    <script src="/scripts/HtmlSanitizer.js"></script>
    <script src="/scripts/utils.js"></script>
  </head>
  <body>
    <script src="/scripts/mediaupload.js"></script>
    <script src="/scripts/navbar.js"></script>
    
    <h1>Edit Profile</h1>

    <form>
      <div class="error" style="background-color: red"></div>
      <br>
      <label for="name">Username</label><br>
      <input type="text" id="name" required/><br>
      <label for="bio">Biography</label><br>
      <textarea id="bio"></textarea><br>
      <label for="avatar">Avatar</label><br>
      <button type="button" onclick="uploadAvatar()">
        Edit Avatar<br>
        <img id="avatar" style="max-width:100px; max-height:100px;">
      </button><br>
      <label for="banner">Banner</label><br>
      <button type="button" onclick="uploadBanner()">
        Edit Banner<br>
        <img id="banner" style="max-width:100px; max-height:100px;">
      </button><br>
      <label for="mature">Mature
        <input type="checkbox" id="mature">
        <span class="checkbox"></span>
      </label><br>
      <input type="submit" value="update"/><br>
    </form>
    <br/>
    <button id="deletebtn">Delete Account</button>
    <script>
      const form = document.querySelector("form");
      const name = document.querySelector("#name");
      const bio = document.querySelector("#bio");
      const avatar = document.querySelector("#avatar");
      const banner = document.querySelector("#banner");
      const mature = document.querySelector("#mature");
      const display = document.querySelector(".error");

      const deletebtn = document.querySelector("#deletebtn");
      deletebtn.onclick = async () => {
        var confirmationPswd = prompt("Warning, this is permanent! Enter your password to continue.");
        if (!confirmationPswd) return;
        await fetch("/api/auth/deleteSelf", {
          method: "DELETE",
          body: JSON.stringify({ confirmationPswd }),
          headers: { "Content-Type": "application/json" },
        });
        location.assign("/");
      };

      (async () => {
        const data = await getAuth();
        if (!data.auth) alert("Not signed in!");
        const user = data.user;
        name.value = user.username;
        bio.value = user.biography || "";
        avatar.src = user.avatar || "";
        banner.src = user.banner || "";
        mature.checked = user.mature;
      })();

      async function uploadAvatar() {
        var url = await getFileUpload(avatar.src);
        if (!url) return;
        avatar.src = url;
      }
      
      async function uploadBanner() {
        var url = await getFileUpload(banner.src);
        if (!url) return;
        banner.src = url;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        display.textContent = "";
        if (avatar.src && !avatar.src.match(/^https?:\/\//))
          return (display.textContent = "Avatar is not a vaild URL");
        if (banner.src && !banner.src.match(/^https?:\/\//))
          return (display.textContent = "Banner is not a vaild URL");
        try {
          const res = await fetch("/api/auth/update", {
            method: "PUT",
            body: JSON.stringify({
              username: name.value,
              biography: bio.value,
              avatar: avatar.src,
              banner: banner.src,
              mature: mature.checked,
            }),
            headers: { "Content-Type": "application/json" },
          });
          if (res.status === 400 || res.status === 401) {
            return (display.textContent =
              data.message + ". " + (data.error ? data.error : ""));
          }
          location.assign("/profile");
        } catch (err) {
          console.error(err.message);
          alert(err.message);
        }
      });
    </script>
  </body>
</html>
